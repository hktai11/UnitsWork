<link rel="stylesheet" href="./css/w3.css">

<style>

    * {
        box-sizing: border-box;
    }

    html, body {
        margin: 0;
        padding: 0;
        height: 100vh;
        overflow: hidden;
        font-size: 20px
    }

    .form-container {
        width: 100%;
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    .form-container>.header {
        display: flex;
        align-items: center;
        justify-content: space-between; 
        background-color: black;
        color: white;
        padding: 5px;
        text-align: center;
        font-weight: bold;
    }
    .form-container>.header>.button-icon {
        width: 30px;
        height: 30px;
        cursor: pointer;
    }
    .form-container>.footer {
        display: flex;
        flex-direction: column;
        width: 100%;
        height: 100%;
        gap: 5px;
        background-color: #f5f5dc;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        overflow-y: auto;
        padding: 10px;
    }
    .form-container>.footer>.card {
        width: 100%;
        padding: 10px;
        word-wrap: break-word;
        background-color: white;
        border-radius: 5px;
    }
    .form-container>.footer>.info-container {
        display: flex;
        width: 100%;
        height: 100%;
        border: 1px solid lightgray;
        background-color: lightgray;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        overflow: hidden;
        position: relative;
    }
    .form-container>.footer>.info-container>.info-content-wrapper {
        flex: 1;
        width: 100%;
        height: 100%;
        overflow: auto;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        box-sizing: border-box;
    }
    .form-container>.footer>.info-container>.info-content-wrapper>.info-content {
        padding: 10px;
        text-align: center;
        word-wrap: break-word;
    }
    .form-container>.scrollable-container {
        flex-grow: 1;
        width: 100%;
        overflow-y: auto;
        padding: 10px;
    }
    .form-container>.scrollable-container>.form-fields {
        width: 100%;
    }
    .form-container>.scrollable-container>.form-fields>.form-field {
        display: flex; 
        flex-direction: row; 
        align-items: center;
        width: 100%; 
        background-color: white; 
        padding: 3px; 
    }
    .form-container>.scrollable-container>.form-fields>.form-field>.button-icon {
        width: 30px;
        height: 30px;
        margin-right: 10px;
        cursor: pointer;
    }
    .form-container>.scrollable-container>.form-fields>.form-field>input[type="text"],
    .form-container>.scrollable-container>.form-fields>.form-field>textarea {
        flex: 1;
        padding: 5px;
        border-radius: 5px;
    }
    .form-container>.scrollable-container>.form-fields>.form-field>textarea {
        resize: none;
    }
    .form-container>.scrollable-container>.form-fields>.form-field>.layers {
        flex: 1;
        padding: 5px;
        margin-right: 10px;
        position: relative;
        width: 100%;
        height: 50px;
    }
    .form-container>.scrollable-container>.form-fields>.form-field>.layers>.layer {
        position: absolute;
        width: calc(100% - 10px);
        height: 40px;
        background-color: white;
        border: 2px solid black;
    }
    .form-container>.scrollable-container>.form-fields>.form-field>.layers>.layer:nth-child(1) {
        top: 0;
        left: 0;
    }
    .form-container>.scrollable-container>.form-fields>.form-field>.layers>.layer:nth-child(2) {
        top: 5px;
        left: 5px;
    }
    .form-container>.scrollable-container>.form-fields>.form-field>.layers>.layer:nth-child(3) {
        top: 10px;
        left: 10px;
    }    
    .form-container>.scrollable-container>.form-fields>.form-options {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        padding-left: 20px;
        padding-right: 50px;
    }
    .form-container>.scrollable-container>.form-options>.option {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 50px;
        height: 50px;
        border: 2px solid black;
        border-radius: 50%;
        text-align: center;
        font-size: 60%;
        cursor: pointer;
    }
    .form-container>.scrollable-container>.button-container {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 10px;
    }
    .form-container>.scrollable-container>.button-container>.button-icon {
        width: 40px;
        height: 40px;
        cursor: pointer;
    }

    .action-container {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    .action-container>.header {
        display: flex;
        align-items: center;
        justify-content: space-between; 
        background-color: black;
        color: white;
        padding: 5px;
        text-align: center;
        font-weight: bold;
    }
    .action-container>.header>.button-icon {
        width: 30px;
        height: 30px;
        cursor: pointer;
    }
    .action-container>.footer {
        display: flex;
        flex-direction: column;
        width: 100%;
        height: 100%;
        gap: 5px;
        background-color: #f5f5dc;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        overflow-y: auto;
        padding: 10px;
    }
    .action-container>.scrollable-container {
        flex-grow: 1;
        width: 100%;
        overflow-y: auto;
        padding: 10px;
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .action-container>.scrollable-container>.item {
        position: relative;
        width: 100%;
        padding: 20px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
    }
    .action-container>.scrollable-container>.item:last-child {
        border-bottom: none;
    }
    .action-container>.scrollable-container>.item>.badge {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 30px;
        height: 30px;
        background-color: #007bff;
        color: #fff;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 50%;
        font-weight: bold;
    }
</style>

<script src="./js/jquery-3.4.1.min.js"></script>

<div class="form-container">
    <div class="header">
        <img src="images/backNavigation.png"
             class="button-icon"
             onclick="showActions(); return false;">
        <span>Form</span>
        <img src="images/submit.png"
             class="button-icon"
             onclick="submitForm(); return false;">
    </div>
    <div class="scrollable-container">
        <div class="form-fields">
        </div>
        <!--
        <div class="button-container">
            <img src="images/add.png"
                 class="button-icon"
                 onclick="addFormField(); return false;">
        </div>
        -->
    </div>
    <div class="footer"
         style="height: 50vh">
    </div>
</div>

<div class="action-container"
     style="display: none">
    <div class="header">
        <span>Actions</span>
    </div>
    <div class="scrollable-container">
    </div>
    <div class="footer"
         style="display: none; height: 50vh">
    </div>
</div>

<script>

    var baseURL = "http://218.255.16.118/YuHingTesting1/api/Mobile/ActionFormsAPI/";

    $(document).ready(function () {
        addFormField(1);
        addFormField(2);
        getActionForms();

        addActionItem('Classify raw', 100);
    });

    function getTextField() {
        return $('<input>', {
            type: 'text',
            placeholder: 'Text'
        });
    }

    function getTextAreaField() {
        return $('<textarea>', {
            placeholder: "Multiple Lines Text"
        });
    }

    function getFormsField() {
        var layers = $('<div>', {
            class: 'layers',
        });
        $('<div>', {
            class: 'layer',
        }).appendTo(layers);
        $('<div>', {
            class: 'layer',
        }).appendTo(layers);
        $('<div>', {
            class: 'layer',
        }).appendTo(layers);
        return layers;
    }

    function addFormField(type) {
        var container = $('.form-container').find('.scrollable-container').find('.form-fields');
        var fieldContainer = $('<div>', {
            class: 'form-field',
            'data-type': '1'
        }).appendTo(container);
        /*
        var imgDiv = $('<img>', {
            src: 'images/options.png',
            class: 'button-icon',
        }).appendTo(fieldContainer);
        imgDiv.click(function() {
            openOptionsSection(this);
        });
        */
        if (type == 1) {
            getTextField().appendTo(fieldContainer);
        }
        else if (type == 2) {
            getTextAreaField().appendTo(fieldContainer);
        }

        /*
        var optionsContainer = $('<div>', {
            class: 'form-options',
            css: { display: 'none' }
        }).appendTo(container);
        var textOption = $('<div>', {
            class: 'option',
            text: 'Text',
            'data-type': '1'
        }).appendTo(optionsContainer);
        textOption.click(function() {
            changeFormFieldType(this)
        });
        var formsOption = $('<div>', {
            class: 'option',
            text: 'Forms',
            'data-type': '2'
        }).appendTo(optionsContainer);
        formsOption.click(function() {
            changeFormFieldType(this)
        });

        var scrollableContainer = $('.form-container').find('.scrollable-container');
        var addButton = scrollableContainer.find('.button-container');
        scrollableContainer.animate({
            scrollTop: addButton.offset().top - scrollableContainer.offset().top + scrollableContainer.scrollTop()
        }, 500);
        */
    }

    function openOptionsSection(elem) {
        var container = $(elem).closest('.form-field').next();
        if (container.is(':visible')) {
            container.hide();
        } 
        else {
            container.show();
        }
    }

    function changeFormFieldType(elem) {
        var type = parseInt($(elem).attr('data-type'));
        var options = $(elem).closest('.form-options');
        var formField = options.prev();
        formField.attr('data-type', type);
        if (type == 1) {
            formField.children().first().replaceWith(getTextField());
        }
        else if (type == 2) {
            formField.children().first().replaceWith(getFormsField());
        }
        options.hide();
    }

    function submitForm() {
        var model = {
            formsID: 29,
            formID: '',
            fields: []
        };
        var fieldID = 1;
        var formTitle = "";
        var container = $('.form-container').find('.scrollable-container').find('.form-fields');
        container.children('.form-field').each(function(){
            var field = {
                fieldID: fieldID,
                type: 1,
                value: ''
            };
            var type = parseInt($(this).attr('data-type'));
            if (type == 1) {
                field.value = $(this).find('input').val();
                if (formTitle == '') {
                    formTitle = field.value;
                }
            }
            model.fields.push(field);
            fieldID++;
        });
        $.ajax({
            url: baseURL + 'SaveActionForm',
            type: "post",
            contentType: 'application/json',
            data: JSON.stringify(model),
            success: function (result) {
                if (result.status == 'success') {
                    refreshForm(formTitle);
                }
                else {
                    alert('未能存入 !')
                }
            },
            error: function (result) {
                alert('未能送出 !')
            },
        });
    }

    function refreshForm(fieldValue) {
        $('<div>', {
            class: 'card',
            text: fieldValue,
        }).prependTo($('.form-container').find('.footer'));
        var container = $('.form-container').find('.scrollable-container').find('.form-fields');
        container.find('input').val('');
        container.find('textarea').val('');
        $('.form-container').find('.footer').show();
    }

    function showFullForm() {
        $('.form-container').find('.footer').hide();
    }

    function getActionForms() {
        $('.form-container').find('.footer').html('');
        var model = {
            formsID: 29,
            searchKey: ''
        };
        $.ajax({
            url: baseURL + 'GetActionForms',
            type: "post",
            contentType: 'application/json',
            data: JSON.stringify(model),
            success: function (result) {
                if (result.status == "success") {
                    var fields = [];
                    result.model.fields.forEach(function (item) {
                        var field = {
                            formID: item.formID,
                            formTitle: item.formTitle
                        };
                        fields.push(field);
                    });
                    for (var i = 0; i < fields.length; i++) {
                        $('<div>', {
                            class: 'card',
                            text: fields[i].formTitle,
                            'data-id': fields[i].formID
                        }).appendTo($('.form-container').find('.footer'));
                    }
                    $('.form-container').find('.footer').show();
                }
            },
            error: function (result) {

                alert('error');

            },
        });
    }
    function getActionForm() {
        var model = {
            formsID: 29,
            formID: 'cb154a9e-4e7f-4c54-9211-bea30fa6442b'
        };

        $.ajax({
            url: baseURL + 'GetActionForm',
            type: "post",
            contentType: 'application/json',
            data: JSON.stringify(model),
            success: function (result) {
                if (result.status == "success") {
                    var fields = [];

        //                    alert(result.model.fields.length);

                    result.model.fields.forEach(function (item) {
                        var field = {
                            fieldID: item.fieldID,
                            type: item.type,
                            value: item.value
                        };
                        fields.push(field);

                                alert(field.fieldID + ' - ' + field.type + ' - ' + field.value);

                    });
                }
            },
            error: function (result) {

                alert('error');

            },
        });
    }

    function showActions() {
        $('.form-container').hide();
        $('.action-container').show();
    }

    function addActionItem(title, number) {
        var container = $('.action-container').find('.scrollable-container');
        var itemContainer = $('<div>', {
            class: 'item',
            text: title
        }).appendTo(container);
        itemContainer.click(function() {
            showActionItems();
        });

        var badge = $('<div>', {
            class: 'badge',
            text: number > 99 ? "99+" : number.toString()
        }).appendTo(itemContainer);
        badge.click(function(event) {
            showPendingActionItems(event);
        });
    }

    function showActionItems() {
        $('.action-container').find('.footer').show();
    }

    function showPendingActionItems(event) {
        event.stopPropagation();
        $('.action-container').find('.footer').show();
    }

</script>
